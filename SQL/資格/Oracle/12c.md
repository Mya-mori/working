# 復習

1.　FOREIGN KEY制約
親表として指定された表は、参照されている行がない場合でも削除できなくなります。親表を削除する場合は、参照している子表を先に削除しなければなりません。

2.　UNIQUE制約
重複禁止で, 定義されている列にNULL値を格納できる

3.　FOREIGN KEY制約
主キーもしくは一意キーの列の値かNULL値を格納できる

4.　TRIM関数
引数で指定された文字列の前後にある削除文字を取り除いた文字列を返す

```sql
　TRIM([LEADING | TRAILING | BOTH] [削除文字] FROM 文字列)
or
　TRIM(文字列)
```

※ LEADING,TRAILING,BOTHを省略した場合は、文字列の前後の削除文字が取り除かれます。
・LEADING：先頭の削除文字を取り除く
・TRAILING：末尾の削除文字を取り除く
・BOTH：前後の削除文字を取り除く（デフォルト）
※ 削除文字には任意の1文字を指定できますが、文字列は指定できません

5.　検索

```sql
WHERE prod_name LIKE q'(%HITSW_%'s%)' ESCAPE 'W';
-- ここではエスケープ文字として「W」を指定していますので、「W」の直後のワイルドカードは通常のリテラルとして扱われます。
```

```sql
WHERE prod_name LIKE '%HITSW_%''s%' ESCAPE 'W';
-- ここではエスケープ文字として「W」を指定していますので、「W」の直後のワイルドカードは通常のリテラルとして扱われます。
```

- 文字パターンには、任意の1文字と一致する「_」や、0文字以上の任意の文字列と一致する「%」といった、ワイルドカードを利用できます

6.　データ型
VARCHAR2型はデータ長の省略ができないため、エラーとなります

7.　抽出

```sql
SELECT
    SUBSTR(INITCAP(name), 1, 2) || REPLACE(startdate, '-') "Code"
FROM
    prod WHERE name IS NOT NULL;
```

- SUBSTR(文字列, m[, n])
文字列のm番目からn文字分の文字列を返す

- REPLACE(文字列, 変更前文字列 [, 変更後文字列])
変更後文字列が省略された場合は、文字列から変更前文字列を削除した文字列を返す

- INITCAP(文字列)
先頭の単語を大文字にする. 2文字目以降は小文字にする.

- HAVINGの指定
  - SELECT文にWHERE句、GROUP BY句、HAVING句を同時に指定する場合は、WHERE句、GROUP BY句、HAVING句またはWHERE句、HAVING句、GROUP BY句の順に指定

  - HAVING句に列別名を指定することはできない
  - HAVING句にはGROUP BY句で指定した列、もしくはグループ関数のみ指定できる

8.　DML(データ操作言語)

- スキーマ・オブジェクトのデータにアクセスし変更や削除など
  - データの更新(UPDATE, DELETE)
  - SELECT, INSERT
- 一つ以上のDML文のまとまりが一つのトランザクション

8.1　DDL(データ定義言語)

- CREATE, ALTER, DROP, TTRUNCATE
- 一つ以上のDDL文のまとまりが一つのトランザクション

-8.2　DCL(データ制御言語)

- GRANT, REVOKE
- 一つ以上のDCL文のまとまりが一つのトランザクション

9.　NLV

- NLV
第1引数の値がNULL値の場合は第2引数の値を返し、第1引数の値がNULL値以外の場合はそのまま第1引数の値を返す.同じデータ型である必要がある.

```sql
NLV(AAA, BBB)
```

- NLV2(AAA, BBB, CCC)
NVL2関数は、第1引数の値がNULL値以外の場合は第2引数の値を返し、第1引数の値がNULL値の場合は第3引数の値を返す.第3引数は第2引数と同じデータ型である必要があるが, 第1引数とは異なるデータ型でも良い

```sql
NLV2(AAA, BBB, CCC)
-- AAAがNULL以外 → BBB
-- AAAがNULL以外 → CCC
```

10.　UPDATE

```sql
UPDATE employees
　  SET (salary, commission)
　　 = (SELECT salary * 1.2, commission + 200000
　　　　FROM employees
　　　　WHERE employee_id = 1010)
WHERE department_id = 5;
--------------------------------------------
UPDATE employees
    SET salary = (SELECT salary * 1.2 FROM employees WHERE employee_id = 1010),
        commission = (SELECT commission + 200000 FROM employeesWHERE employee_id = 1010)
WHERE department_id = 5;
```

- 副問合せを指定したUPDATE文では、副問合せで取り出された列しかSET句に指定することができない

11.　制約
制約は列レベル、表レベルで定義することができます。制約を定義する場合は、次の事項に注意します。

- CONSTRAINT 制約名は省略することができる
- CONSTRAINT 制約名を省略した場合は、「SYS_Cn」という制約名となる（nには一意の番号が振られる）
- 1つの列に複数の列レベル制約を定義する場合は、スペースで区切って定義する
　　例) 列名 データ型 [[CONSTRAINT 制約名1] 制約の種類] [[CONSTRAINT 制約名2] 制約の種類]
- 1つの表に複数の表レベル制約を定義する場合は、カンマで区切って定義する
- 列レベル制約と表レベル制約では機能に違いはない
- 列レベル制約と表レベル制約は1つの表で同時に指定できる
- 複数の列の組み合わせに対して制約を定義する場合は、表レベル制約でのみ定義できる
- NOT NULL制約は列レベルでのみ定義できる

- ON DELETE CASCADE 子表が親表を参照している場合, 親表の行を削除すると参照している子表の行も削除される
- ON DELETE SET NULL 子表が親表を参照している場合, 親表の行を削除すると参照している子表の行にNULLが設定される
12.　置換処理

- 実行時に条件などの値を指定することができる
- &置換変数
SQL文実行後に置き換えた値が破棄される
- &&置換変数
SQL文実行後に置き換えた値が保持される

13.　COALESCE関数

- 引数の値を判定し、最初に見つかったNULL値以外の値を返す関数
- すべて同じデータ型でなければならない

14.　副問合せ

- NOT IN演算子の値のリストにNULL値が含まれていると、NULL値と比較対象の値の比較結果がNULL値になるので、全ての値と等しくないという判定がなされる

15.　LISTAGG関数

- 複数行の列の値を連結して1行で表示できる関数

```sql
LISTAGG(連結して表示する列名 [, 'デリミタ'])
WITHIN GROUP(ORDER BY ソートする項目 [ASC | DESC])
```

16.　バイナリデータ型

- RAW      最大2,000B
- LONG RAW 最大2GB
- BLOB     最大4GB
- BFILE    最大4GB only read

17.　スキーマ

- 表やビュー等のスキーマ・オブジェクトは必ずいずれかのユーザーに所有されています。スキーマとは、オブジェクトの所有者を表す論理的な概念
- 他のユーザーが所有する表を参照するときには、スキーマ名を接頭辞として参照

18.　DECODE関数

```sql
DECODE(式, 条件1, 戻り値1
　　　　　　[, 条件2, 戻り値2 …]
　　　　　　[, デフォルトの戻り値])
```

19.　トランザクションの開始と終わり

- COMIT及びROLLBACKの実行
- DDLの実行
- DCLの実行
- SQL DeveloperやSQL *Plusの終了
- システム障害

20.　FOR UPDATE句

```sql
SELECT 列名 [,列名, ...]
FROM 表名
[WHERE 条件]
FOR UPDATE [OF [表名.]列名] [NOWAIT | WAIT n]
[ORDER BY 列名 [, 列名, ...]];
```

- NOWAIT
別のセッションでロックがされている場合, 待機せずにエラーを返す
- WAIT n
別のセッションでロックがされている場合, n秒待機しロックが解除されていない場合,待機せずにエラーを返す
- OF 表名.列名
指定した 表名,列名が含まれる行だけロック

21.　クエリの評価順
列別名はORDER BY句でのみ指定できます。これはSQL文が以下の順序で評価される為、SELECT句で指定した列別名を認識できるのはORDER BY句のみだからです。
（評価順）FROM句→WHERE句→GROUP BY句→HAVING句→SELECT句→ORDER BY句

22.　SUBSTR関数とINSTR関数

- SUBSTR関数は引数で指定された文字列の部分文字列を返す

``` sql
SUBSTR(文字列, m[,n])
-- m文字目からn文字目の文字列を返す
```

- INSTR関数は引数で指定した文字列中から検索文字列を検索し、その位置を返します。検索文字列が見つからなかった場合は0（ゼロ）を返す

```sql
INSTR(文字列, 検索文字列[,m][,n])
-- m文字目以降からn回目に出現した検索文字列の先頭の位置
```

24.　連結演算子

- 連結演算子はデータ型が異なっていても, 連結できる. 連結後は文字列使いになる

```sql
SELECT hiredate || employee_name "date" FROM employees
ORDER BY date;
-- dateではorder byできない
-- "date"とする必要がある
```

